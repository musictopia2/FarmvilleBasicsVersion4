@inherits TimedOnlyComponent

<PopupViewport TapToClose=true
                ShowHeaders="false"
               @bind-Visible="_showPowerGloves">
    <PowerGloveWorkshopComponent Workshop="Workshop"
        OnClose="ClosePowerGloves"
        />
</PopupViewport>

<PopupViewport @bind-Visible="_showUpgrades"
               TapToClose="true"
               ShowHeaders="false">
    <UpgradeWorkshopModal Workshop="Workshop"
                        OnUpgraded="Upgraded" />
</PopupViewport>

@if (_showConfirmation)
{
    <ConfirmationBlazor Title="Complete Active Item"
        Message="@GetConfirmationMessage"
        Results="ConfirmCompleteWorkshop"
        />
}

@if (_recipes.Count == 0)
{
    <div class="alert alert-warning">
        No recipes available for this workshop.
    </div>
    return;
}
@* <div style="font-size: 1.6rem; font-weight: bold;">
    Queue slots: @_capacity
</div> *@
<div style="height: 30px;">

</div>
@{
    var visibleQueue = GetVisibleQueue();
    bool anyActive = visibleQueue.Any(x => x.State == EnumWorkshopState.Active);
}


<div style="margin-top: -40px" class="boost-buttons-reserve">

    <div class="@(anyActive ? "" : "boost-hidden")"
         @onclick="OnFinishNowClicked">
        <BoostIconComponent Name="@CurrencyKeys.FinishSingleWorkshop" ImageSize="80" />
    </div>
    <div style="margin-left: -20px;" class="@(anyActive ? "" : "boost-hidden")"
         @onclick="OnPowerGloveClicked">
        <BoostIconComponent Name="@CurrencyKeys.PowerGloveWorkshop" ImageSize="80" />
    </div>
    
    

   
</div>



<StackLayout ItemSpacing="5px">
    <SimpleRepeater HowMany="_capacity" Context="slotIndex">
        @{
            // slotIndex is the DISPLAY slot (1..capacity), not the real slot anymore
            CraftingSummary? current = null;
            int i = slotIndex - 1;
            if (i >= 0 && i < visibleQueue.Count)
            {
                current = visibleQueue[i];
            }

            bool stopBubble = current is not null && slotIndex == 1;
        }

        <StackItem StopClickPropagation="stopBubble">
            <div class="queue-slot @SlotClass(slotIndex)">
                @if (current is not null)
                {
                    @if (current.State == EnumWorkshopState.Active)
                    {
                        @* <button type="button"
                                class="powerglove-btn"
                                @onclick="OnPowerGloveClicked"
                                @onclick:stopPropagation="true">
                                <BoostIconComponent Name="@CurrencyKeys.PowerGloveWorkshop" ImageSize="26" />
                            
                        </button> *@
                        
                        <div class="queue-badge">
                            @GetTimeText(current)
                        </div>
                    }

                    <img class="queue-img" src="@Image(current)" alt="" />
                }
            </div>
        </StackItem>
    </SimpleRepeater>

    @* NEW: upgrade button shown only if NOT maxed *@
    @if (CanShowPossibleNewCapacity)
    {
        <StackItem>




            <div class="upgrade-slot upgrade-cost-btn" @onclick="UpgradeWorkshopCapacity">
                <img src="/coin.png" alt="Coin" class="coin-img" />
                <span class="upgrade-cost-text">@UpgradeManager.NextWorkshopCapacityCoinCost(Workshop)</span>
                
            </div>
        </StackItem>
       
    }

</StackLayout>
<div class="workshop-header" @onclick:stopPropagation="true">
    <button type="button" class="workshop-nav" @onclick="PreviousClicked" aria-label="Previous workshop">
        <ArrowLeftComponent TargetHeight="10vh" />
        
    </button>
    @if (_anyAdvancedUpgrades)
    {
        <SuccessButton OnClick="ShowUpgrades">
            Get Upgrades
        </SuccessButton>
    }
    else
    {
        <div>

        </div>
    }
    <div class="workshop-title">
        <span class="workshop-name">@WorkshopDetails</span>

        <span class="rental-pill @(string.IsNullOrWhiteSpace(_lastRentalText) ? "rental-pill-hidden" : "")">
            Rental: @_lastRentalText
        </span>
    </div>

    <button type="button" class="workshop-nav" @onclick="NextClicked" aria-label="Next workshop">
        <ArrowRightComponent TargetHeight="10vh" />
    </button>
</div>

<StackLayout>
    <StackItem>
        <div class="req-list">
            @foreach (var req in FullRequirements)
            {

                <ItemRequirementDisplay 
                    OnClicked="NavigateTo"
                    Name="@req.Key"
                    Required="req.Value"
                    Have="InventoryManager.Get(req.Key)"
                    ShowBorder="true"
                    />

                
            }
        </div>

    </StackItem>
    <StackItem StopClickPropagation>
        <img src="@WorkshopImage" height="200" />
    </StackItem>
    @* <StackItem StopClickPropagation="true">
        <PrimaryButton IsEnabled="CanCraft"
                       FontSize="3rem"
                       OnClick="Craft">
            Craft
        </PrimaryButton>
        
    </StackItem> *@
    <StackItem StopClickPropagation>
        <div style="font-size: 2rem; width: 300px; display: flex; flex-direction: column; gap: 6px;">

            <!-- Barn + amount: right aligned -->
            <div style="display: flex; align-items: center; gap: 8px; justify-content: flex-end;">
                <img src="/Barn.png" height="30" />
                <span>@CurrentAmount</span>
            </div>

            <!-- Chosen item row: image left, text flush right, stable -->
            <div style="display: flex; align-items: center; gap: 8px;">

                <div class="workshop-recipe-icon @(CurrentRecipe.Unlocked ? "" : "locked")">
                    <ImageButtonComponent Name="@ChosenItem"
                                          Height="120"
                                          OnClick="Craft" />
                    

                    @if (CurrentRecipe.Unlocked == false)
                    {
                        <img class="workshop-lock"
                             src="/Padlock.png"
                             alt="Locked" />
                    }
                </div>

                

                <div style="flex: 1; min-width: 0; display: flex; flex-direction: column; line-height: 1.1; align-items: flex-end; text-align: right;">
                    <div style="max-width: 100%;
                        overflow: hidden;
                        display: -webkit-box;
                        -webkit-line-clamp: 2;
                        -webkit-box-orient: vertical;">
                        @ChosenItem.GetWords
                    </div>
                    <div style="max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        @DetailText
                    </div>
                </div>
            </div>

        </div>

    </StackItem>

    <StackItem StopClickPropagation="true">
        <div class="workshop-vert-nav">
            <div class="workshop-vert-slot" style="visibility:@(CanGoUp ? "visible" : "hidden")">
                <ArrowUpComponent TargetHeight="10vh"
                                  Clicked="GoUp" />
            </div>

            <div class="workshop-vert-slot" style="visibility:@(CanGoDown ? "visible" : "hidden")">
                <ArrowDownComponent TargetHeight="10vh"
                                    Clicked="GoDown" />
            </div>
        </div>
        
    </StackItem>
</StackLayout>
